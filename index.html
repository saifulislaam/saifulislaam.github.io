<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bottle Counter — Live</title>
  <style>
    :root{
      --bg: #000000;         /* darkest black background */
      --panel: rgba(0,0,0,0.45);
      --accent: #FFD400;     /* yellow accent */
      --text: #ffffff;
      --muted: rgba(255,255,255,0.6);
    }
    html,body{
      height:100%;
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }

    /* big centered number */
    .counter{
      display:flex;
      align-items:center;
      justify-content:center;
      width:clamp(160px, 45vw, 420px);
      height:clamp(160px, 45vw, 420px);
      background:var(--panel);
      border-radius:24px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      position:relative;
      user-select:none;
    }
    .count{
      font-weight:800;
      font-size:clamp(48px, 12vw, 140px);
      color:var(--accent);
      line-height:1;
      margin:0;
      text-align:center;
      letter-spacing: -2px;
    }
    /* small status text */
    .status{
      position: absolute;
      bottom:12px;
      left:12px;
      font-size:13px;
      color:var(--muted);
      background:transparent;
    }

    /* Full-screen subtle footer for instructions on small screens */
    .footer{
      position:fixed;
      bottom:14px;
      right:14px;
      color:var(--muted);
      font-size:13px;
      text-align:right;
    }

    /* Hide the video element but keep it playing */
    video#camera {
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: 160px;
      height: auto;
      border-radius:12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      transform: scaleX(-1); /* mirror for natural view */
      opacity: 0.16; /* subtle preview; set to 0 to hide completely */
      transition:opacity .25s;
      z-index: 2;
    }

    /* Responsive: on very small screens, shrink controls/floats*/
    @media (max-width:420px){
      .counter{ width:86vw; height:86vw; border-radius:18px; }
      .status{ font-size:12px; }
      video#camera { width:120px; opacity:0.12; }
    }

    /* Accessibility focus outline */
    .sr-only{
      position:absolute!important;
      height:1px;width:1px;
      overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <div class="counter" aria-live="polite" aria-atomic="true">
      <p id="count" class="count">—</p>
      <div id="status" class="status">Initializing camera & model…</div>
    </div>
  </div>

  <!-- Subtle video preview (kept low opacity). If you prefer fully hidden camera, set display:none or opacity:0 -->
  <video id="camera" autoplay playsinline muted></video>

  <div class="footer">Only the number of bottles is shown. Camera: on by default.</div>

  <!-- TensorFlow.js and COCO-SSD model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

  <script>
  // Bottle counter script
  (function () {
    const video = document.getElementById('camera');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');

    // Detection settings
    const FRAME_INTERVAL = 150; // ms between detections (adjust for performance)
    let model = null;
    let isDetecting = false;
    let lastCount = null;

    // Helpers
    function setStatus(text) {
      statusEl.textContent = text;
    }

    function setCount(n) {
      // show only the number; use em-dash for unknown/initial
      if (typeof n === 'number') {
        countEl.textContent = String(n);
        lastCount = n;
      } else {
        countEl.textContent = '—';
      }
    }

    async function startCamera() {
      try {
        // prefer rear camera on mobile if available (facingMode: environment)
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
        await video.play();
        return true;
      } catch (err) {
        console.error('Camera error', err);
        setStatus('Camera access denied or not available.');
        setCount('—');
        return false;
      }
    }

    async function loadModel() {
      setStatus('Loading detection model (COCO-SSD)…');
      try {
        model = await cocoSsd.load();
        setStatus('Model loaded. Starting detection…');
        return true;
      } catch (err) {
        console.error('Model load error', err);
        setStatus('Failed to load model.');
        return false;
      }
    }

    async function detectLoop() {
      if (!model || !video || video.readyState < 2) {
        // video not ready; try again soon
        setTimeout(detectLoop, 200);
        return;
      }
      isDetecting = true;

      // small offscreen canvas to run detection on the current video frame
      const tmp = document.createElement('canvas');
      tmp.width = video.videoWidth;
      tmp.height = video.videoHeight;
      const ctx = tmp.getContext('2d');
      ctx.drawImage(video, 0, 0, tmp.width, tmp.height);

      try {
        const predictions = await model.detect(tmp);

        // Filter predictions for class 'bottle' only and with confidence threshold
        const BOTTLE_CONFIDENCE = 0.45; // adjust sensitivity (0-1)
        const bottlePreds = predictions.filter(p => {
          return p.class === 'bottle' && p.score >= BOTTLE_CONFIDENCE;
        });

        const bottleCount = bottlePreds.length;

        // Only update DOM when count changes (less flicker)
        if (bottleCount !== lastCount) {
          setCount(bottleCount);
        }
        setStatus('Detecting bottles — confidence ≥ ' + Math.round(BOTTLE_CONFIDENCE*100) + '%');
      } catch (err) {
        console.error('Detection error', err);
        setStatus('Detection error.');
      } finally {
        // schedule next detection
        setTimeout(detectLoop, FRAME_INTERVAL);
      }
    }

    // Initialize: camera then model then loop
    (async function init() {
      setCount(null);
      setStatus('Requesting camera permission…');

      const camStarted = await startCamera();
      if (!camStarted) return;

      // give camera a tiny moment to stabilize
      await new Promise(res => setTimeout(res, 300));

      const modelLoaded = await loadModel();
      if (!modelLoaded) return;

      // start detection loop
      detectLoop();
    })();

    // Clean up when page hidden/unloaded
    window.addEventListener('beforeunload', () => {
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
      }
    });

    // Pause detection when tab not visible to save CPU
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        setStatus('Paused (tab not visible)');
        // could also stop the camera stream here, but we leave it for simplicity
      } else {
        setStatus('Detecting bottles — resuming');
      }
    });

  })();
  </script>
</body>
</html>